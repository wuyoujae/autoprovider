# ä¸Šä¸‹æ–‡å»é‡ä¼˜åŒ–è®¾è®¡è¯¦ç»†è¯´æ˜

## é—®é¢˜èƒŒæ™¯

åœ¨ Agent å·¥ä½œå¾ªç¯ä¸­ï¼Œå­˜åœ¨ä¸Šä¸‹æ–‡å†…å®¹é‡å¤å ç”¨çš„é—®é¢˜ï¼š

1. **åœºæ™¯**ï¼šAI é€šè¿‡ `edit_file` ç¼–è¾‘æ–‡ä»¶åï¼Œç¼–è¾‘å†…å®¹ä¼šè®°å½•åœ¨ tool æ¶ˆæ¯ä¸­
2. **é—®é¢˜**ï¼šä¸‹ä¸€è½®å¾ªç¯æ—¶ï¼Œ`contextFilePaths` åˆä¼šé‡æ–°è¯»å–è¿™äº›æ–‡ä»¶çš„å®Œæ•´å†…å®¹
3. **ç»“æœ**ï¼šåŒä¸€æ–‡ä»¶çš„å†…å®¹åœ¨ä¸Šä¸‹æ–‡ä¸­å‡ºç°å¤šæ¬¡ï¼Œæµªè´¹å¤§é‡ token

### å…·ä½“æµç¨‹ï¼ˆä¼˜åŒ–å‰ï¼‰

```
ç¬¬1è½®ï¼š
â”œâ”€â”€ level2 åˆ†æ â†’ contextFilePaths = ["src/App.vue"]
â”œâ”€â”€ level3 è¯»å– â†’ App.vue å®Œæ•´å†…å®¹ (800 token)
â”œâ”€â”€ level4 ç»„è£… â†’ presetMessages åŒ…å«å®Œæ•´ App.vue
â””â”€â”€ AI è°ƒç”¨ edit_file â†’ tool è¿”å›ç¼–è¾‘ç»“æœ

ç¬¬2è½®ï¼ˆç³»ç»Ÿé©±åŠ¨å¾ªç¯ï¼‰ï¼š
â”œâ”€â”€ level5 è·å– contextFilePathsï¼ˆä»åŒ…å« App.vueï¼‰
â”œâ”€â”€ level3 å†æ¬¡è¯»å– â†’ App.vue å®Œæ•´å†…å®¹ (800 token) ğŸ”´ é‡å¤
â”œâ”€â”€ assembleChatMessages â†’ åŒ…å«ä¸Šè½®çš„ tool æ¶ˆæ¯ ğŸ”´ é‡å¤
â””â”€â”€ æ€»è®¡ï¼šåŒä¸€æ–‡ä»¶å†…å®¹å ç”¨äº† 1600+ token
```

## ä¼˜åŒ–æ–¹æ¡ˆ

### 1. æ–°å»º `getRecentlyEditedFiles.js`

**åŠŸèƒ½**ï¼šè·å–æœ€è¿‘ N è½®å¯¹è¯ä¸­å·²å¤„ç†çš„æ–‡ä»¶åˆ—è¡¨

**æ ¸å¿ƒé€»è¾‘**ï¼š

- æŸ¥è¯¢ `dialogue_record` è¡¨ä¸­çš„ `tool_call` å­—æ®µ
- è§£æ `edit_file`ã€`create_file`ã€`read_file` è°ƒç”¨
- æå–æ–‡ä»¶è·¯å¾„å¹¶å»é‡

**è¿”å›ç»“æ„**ï¼š

```javascript
{
  editedFiles: [],      // edit_file æ“ä½œçš„æ–‡ä»¶
  createdFiles: [],     // create_file æ“ä½œçš„æ–‡ä»¶
  readFiles: [],        // read_file æ“ä½œçš„æ–‡ä»¶
  allModifiedFiles: [], // editedFiles + createdFiles å»é‡
  allKnownFiles: [],    // æ‰€æœ‰å·²çŸ¥æ–‡ä»¶
}
```

### 2. ä¿®æ”¹ `level5.js`

**æ–°å¢é€»è¾‘**ï¼š

```javascript
// è·å–æœ€è¿‘ 3 è½®å·²å¤„ç†çš„æ–‡ä»¶
const recentlyEditedInfo = await getRecentlyEditedFiles({...});

// ä» contextFilePaths ä¸­è¿‡æ»¤æ‰å·²ç¼–è¾‘/åˆ›å»ºçš„æ–‡ä»¶
const { filtered, skipped } = filterContextFilePaths(
  originalContextFilePaths,
  recentlyEditedInfo,
  {
    skipEdited: true,   // è·³è¿‡å·²ç¼–è¾‘
    skipCreated: true,  // è·³è¿‡å·²åˆ›å»º
    skipRead: false,    // ä¸è·³è¿‡å·²è¯»å–
  }
);
```

### 3. ä¿®æ”¹ `level3.js`

**æ–°å¢åŠŸèƒ½**ï¼š

- æ·»åŠ æ–‡ä»¶åŠ è½½ç»Ÿè®¡ä¿¡æ¯
- è®°å½•è¢«è·³è¿‡çš„æ–‡ä»¶ä¿¡æ¯
- ç”Ÿæˆä¸Šä¸‹æ–‡çŠ¶æ€æŠ¥å‘Š

**è¿”å›ç»“æ„å¢å¼º**ï¼š

```javascript
{
  taskSummary: "...",
  contextFilePaths: [...],
  _contextStats: {
    loadedFiles: 3,
    failedFiles: 0,
    skippedFiles: 2,
    totalChars: 5000,
  },
  _skippedFilesInfo: {
    note: "ä»¥ä¸‹æ–‡ä»¶å·²è¢«ç¼–è¾‘ï¼Œå†…å®¹æœªé‡æ–°åŠ è½½",
    files: ["src/App.vue", "src/api.js"],
  },
}
```

### 4. å¢å¼º `editFile.js`

**æ–°å¢å˜æ›´æ‘˜è¦**ï¼š

```javascript
{
  status: 0,
  message: "editfile success",
  data: {
    file_path: "ç¼–è¾‘ç»“æœï¼šedit success",
    target_file: "src/App.vue",
    is_new_file: false,
    summary: {
      original_length: 1200,
      new_length: 1350,
      original_line_count: 45,
      new_line_count: 50,
      lines_added: 5,
      lines_removed: 0,
      lines_modified: 3,
      change_description: "æ–°å¢ 5 è¡Œï¼Œä¿®æ”¹ 3 è¡Œï¼ˆå˜æ›´ä½ç½®: ç¬¬ 15, 23, 45 è¡Œé™„è¿‘ï¼‰",
    },
    ai_summary: "æˆåŠŸç¼–è¾‘æ–‡ä»¶ src/App.vueï¼Œæ–°å¢ 5 è¡Œï¼Œä¿®æ”¹ 3 è¡Œ",
  },
}
```

## ä¼˜åŒ–åæµç¨‹

```
ç¬¬1è½®ï¼š
â”œâ”€â”€ level2 åˆ†æ â†’ contextFilePaths = ["src/App.vue", "src/api.js"]
â”œâ”€â”€ level3 è¯»å–æ–‡ä»¶ï¼ˆå®Œæ•´å†…å®¹ï¼‰
â”œâ”€â”€ level4 ç»„è£… presetMessages
â””â”€â”€ AI è°ƒç”¨ edit_file â†’ è¿”å›ç²¾ç®€æ‘˜è¦ï¼ˆä¸å«å®Œæ•´å†…å®¹ï¼‰

ç¬¬2è½®ï¼ˆç³»ç»Ÿé©±åŠ¨å¾ªç¯ï¼‰ï¼š
â”œâ”€â”€ level5 è·å– contextFilePaths
â”œâ”€â”€ getRecentlyEditedFiles æ£€æµ‹åˆ° App.vue å·²è¢«ç¼–è¾‘
â”œâ”€â”€ filterContextFilePaths è¿‡æ»¤ â†’ åªä¿ç•™ src/api.js
â”œâ”€â”€ level3 åªè¯»å– src/api.jsï¼ˆè·³è¿‡ App.vueï¼‰
â”œâ”€â”€ assembleChatMessages åŠ è½½å¯¹è¯å†å²
â””â”€â”€ æ— é‡å¤å†…å®¹ï¼Œä¸Šä¸‹æ–‡ç©ºé—´å¤§å¹…èŠ‚çœ âœ…
```

## é…ç½®é€‰é¡¹

åœ¨ `filterContextFilePaths` ä¸­å¯é…ç½®è·³è¿‡ç­–ç•¥ï¼š

| é€‰é¡¹          | é»˜è®¤å€¼  | è¯´æ˜                                        |
| ------------- | ------- | ------------------------------------------- |
| `skipEdited`  | `true`  | è·³è¿‡å·²ç¼–è¾‘çš„æ–‡ä»¶ï¼ˆAI åˆšåˆšç¼–è¾‘è¿‡ï¼ŒçŸ¥é“å†…å®¹ï¼‰ |
| `skipCreated` | `true`  | è·³è¿‡å·²åˆ›å»ºçš„æ–‡ä»¶ï¼ˆAI åˆšåˆšåˆ›å»ºçš„ï¼ŒçŸ¥é“å†…å®¹ï¼‰ |
| `skipRead`    | `false` | ä¸è·³è¿‡å·²è¯»å–çš„æ–‡ä»¶ï¼ˆå¯èƒ½éœ€è¦å†æ¬¡å‚è€ƒï¼‰      |
| `turnsBack`   | `3`     | å¾€å‰è¿½æº¯å‡ è½®å¯¹è¯                            |

## é¢„æœŸæ•ˆæœ

- **ä¸Šä¸‹æ–‡èŠ‚çœ**ï¼šé‡å¤æ–‡ä»¶ä¸å†åŠ è½½ï¼Œé¢„è®¡èŠ‚çœ 30-50% ä¸Šä¸‹æ–‡ç©ºé—´
- **å“åº”é€Ÿåº¦**ï¼šå‡å°‘æ–‡ä»¶ I/Oï¼Œæé«˜å“åº”é€Ÿåº¦
- **AI è®¤çŸ¥**ï¼šé€šè¿‡ `_skippedFilesInfo` è®© AI çŸ¥é“å“ªäº›æ–‡ä»¶è¢«è·³è¿‡ï¼Œä¿æŒä¸Šä¸‹æ–‡è¿è´¯æ€§
