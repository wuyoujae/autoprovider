# 更新日志 - server.py 改进

## 📅 更新时间

2024 年最新版本

## ✨ 主要改进

### 1. 🔐 Token 身份验证

**新增功能:**

- 添加 JWT token 验证中间件
- 所有上传接口需要身份验证
- 自动验证 token 有效性和过期时间

**使用方法:**

```bash
# 请求头中添加Authorization
curl -X POST http://localhost:5000/api/v1/inter/upload_and_parse \
  -H "Authorization: Bearer YOUR_JWT_TOKEN" \
  -F "files=@document.pdf"
```

**错误返回:**

```json
{
  "status": 1,
  "message": "未提供身份验证令牌，请先登录",
  "data": "fail"
}
```

### 2. 📋 严格的文件验证

**新增验证项:**

1. **文件数量验证**

   - 单次最多 10 个文件
   - 超过限制返回错误

2. **文件类型验证**

   - 检查文件扩展名
   - 只允许预定义的文件类型
   - 返回支持的格式列表

3. **文件大小验证**

   - 最小: 100 bytes
   - 最大: 5 MB
   - 返回具体的限制信息

4. **图片有效性验证**

   - 验证图片是否可以正常打开
   - 检查图片尺寸（10x10 到 10000x10000）
   - 验证图片格式

5. **项目存在性验证**
   - 如果提供 project_id，验证项目是否存在
   - 检查项目状态

### 3. 📊 详细的日志输出

**控制台日志改进:**

#### 启动日志

```
================================================================================
  🚀 AutoProvider 文档解析服务启动中...
================================================================================

📋 基本配置:
  • 支持的文件格式: bmp, csv, doc, docx...
  • 最大文件大小: 5.0MB
  • 最小文件大小: 100 bytes
  • 单次最多上传: 10 个文件

🔐 安全配置:
  • Token验证: ✅ 已启用
  • JWT算法: HS256
  • 需要在请求头添加: Authorization: Bearer <token>

...
```

#### 请求处理日志

```
================================================================================
📤 收到文件上传请求
   用户ID: user-123
   用户名: testuser
================================================================================

📋 收到 2 个文件

🔍 开始验证文件...

  📄 文件 1/2: document.pdf
     📏 文件大小: 245.67KB
     📋 文件类型: pdf
     ✅ 文件验证通过

  📄 文件 2/2: image.png
     📏 文件大小: 89.34KB
     📋 文件类型: png
     ✅ 图片有效: 800x600px

✅ 所有文件验证通过！
```

#### 图片解析日志

```
============================================================
📷 开始提取文档中的图片: document.pdf
============================================================

--- 图片 1 (picture) ---
  ├─ 正在提取图片...
  ├─ 图片尺寸: 1024x768px
  ├─ 图片大小: 123.45KB
  ├─ 正在上传到七牛云: document-picture1.png
  ├─ ✅ 上传成功: https://xxx.com/image.png
  ├─ 🤖 开始AI解析图片内容...
  ├─ ✅ AI解析完成，描述长度: 456字符
  ├─ 📝 AI描述预览: 这是一张展示...
  ├─ 💾 正在存储到数据库...
  └─ ✅ 完成! source_id: uuid-123

============================================================
✅ 图片提取完成! 共处理 3 张图片，成功 3 张
============================================================
```

#### 直接上传图片日志

```
▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶
📌 处理第 1/1 个文件
   文件名: photo.jpg
   类型: jpg
   大小: 234.56KB
▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶

📷 图片处理流程开始
   ├─ 步骤1: 读取图片信息
   ├─ 图片尺寸: 1920x1080px
   ├─ 图片格式: JPEG
   ├─ 步骤2: 上传到七牛云
   ├─ ✅ 上传成功: https://xxx.com/photo.jpg
   ├─ 步骤3: AI解析图片内容
   ├─ 🤖 调用视觉大模型中...
   ├─ ✅ AI解析完成，描述长度: 678字符
   ├─ 📝 AI描述预览: 图片展示了...
   ├─ 步骤4: 存储到数据库
   └─ ✅ 完成! source_id: uuid-456
```

### 4. ⚠️ 改进的错误处理

**错误类型:**

1. **Token 错误**

   ```
   ❌ Token验证失败: 未提供token
   ❌ Token验证失败: token已过期
   ❌ Token验证失败: 无效的token
   ```

2. **文件验证错误**

   ```
   ❌ 错误: 文件数量超过限制 (15 > 10)
   ❌ 错误: 文件太小，最小需要100字节
   ❌ 错误: 文件太大，最大允许5.0MB
   ❌ 不支持的文件类型: exe
   ❌ 无效的图片文件: cannot identify image file
   ```

3. **处理错误**
   ```
   ❌ 处理文件异常: document.pdf
      错误信息: ...
      堆栈跟踪: ...
   ```

### 5. 📦 需要安装的新依赖

```bash
pip install PyJWT
```

### 6. ⚙️ 配置说明

**JWT 密钥配置（server.py 第 46 行）:**

```python
JWT_SECRET_KEY = 'autoprovider_secret_2024'  # 需要与Node.js后端保持一致
```

**⚠️ 重要:** 确保 Python 的 JWT_SECRET_KEY 与 Node.js 后端的 JWT 密钥完全一致！

在 Node.js 中（通常在`config/jwt.js`）:

```javascript
module.exports = {
  jwtSecretKey: "autoprovider_secret_2024",
};
```

### 7. 🔍 验证流程

**完整的验证流程:**

```
1. 检查Authorization头是否存在
2. 验证Token格式和签名
3. 检查Token是否过期
4. 提取用户信息（user_id, username）
5. 验证文件是否上传
6. 验证文件数量
7. 验证每个文件的类型
8. 验证每个文件的大小
9. 对图片进行额外验证
10. 如果有project_id，验证项目存在
11. 开始处理文件
```

### 8. 📤 API 响应格式

**成功响应:**

```json
{
  "status": 0,
  "message": "成功处理2个文件",
  "data": [
    {
      "source_id": "uuid-1",
      "source_url": "",
      "source_type": "pdf",
      "filename": "document.pdf",
      "content_length": 1234,
      "extracted_images": 2,
      "images": [...]
    },
    {
      "source_id": "uuid-2",
      "source_url": "https://xxx.com/image.png",
      "source_type": "png",
      "filename": "image.png",
      "ai_description": "这是一张...",
      "width": 800,
      "height": 600
    }
  ]
}
```

**失败响应（遵循 codeStandards.md）:**

```json
{
  "status": 1,
  "message": "具体的错误信息",
  "data": "fail"
}
```

### 9. 🧪 测试建议

**测试 Token 验证:**

```bash
# 无Token - 应该返回401
curl -X POST http://localhost:5000/api/v1/inter/upload_and_parse \
  -F "files=@test.pdf"

# 有效Token - 应该成功
curl -X POST http://localhost:5000/api/v1/inter/upload_and_parse \
  -H "Authorization: Bearer VALID_TOKEN" \
  -F "files=@test.pdf"
```

**测试文件验证:**

```bash
# 超大文件 - 应该返回错误
# 不支持的格式 - 应该返回错误
# 损坏的图片 - 应该返回错误
# 过多文件 - 应该返回错误
```

### 10. 📝 控制台输出示例

**完整的处理流程日志:**

```
================================================================================
📤 收到文件上传请求
   用户ID: 123
   用户名: testuser
================================================================================

📋 收到 1 个文件
📁 未提供项目ID

🔍 开始验证文件...

  📄 文件 1/1: test-image.png
     📏 文件大小: 89.34KB
     📋 文件类型: png
     ✅ 图片有效: 800x600px

✅ 所有文件验证通过！

================================================================================
🚀 开始处理文件...
================================================================================

▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶
📌 处理第 1/1 个文件
   文件名: test-image.png
   类型: png
   大小: 89.34KB
▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶▶

📷 图片处理流程开始
   ├─ 步骤1: 读取图片信息
   ├─ 图片尺寸: 800x600px
   ├─ 图片格式: PNG
   ├─ 步骤2: 上传到七牛云
   ├─ ✅ 上传成功: https://xxx.com/test-image.png
   ├─ 步骤3: AI解析图片内容
   ├─ 🤖 调用视觉大模型中...
[AI输出流式内容...]
   ├─ ✅ AI解析完成，描述长度: 456字符
   ├─ 📝 AI描述预览: 这是一张展示了...
   ├─ 步骤4: 存储到数据库
   └─ ✅ 完成! source_id: abc-123-def

================================================================================
🎉 所有文件处理完成!
   总文件数: 1
   成功: 1
   失败: 0
================================================================================
```

## 🎯 总结

这次更新主要增强了：

1. ✅ 安全性（Token 验证）
2. ✅ 健壮性（严格的文件验证）
3. ✅ 可观测性（详细的日志输出）
4. ✅ 错误处理（更友好的错误信息）
5. ✅ 用户体验（清晰的反馈）

现在您可以清楚地看到：

- 每个请求的用户信息
- 文件验证的每一步
- 图片 AI 解析是否正常执行
- 每个步骤的成功或失败状态
